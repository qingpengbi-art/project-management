# 人员参与项目统计修复说明

## 📋 问题描述

在人员管理页面中，"参与项目"字段的统计数据不正确。

### 问题根源
原来的统计逻辑直接统计 `ProjectMember` 表（项目直接成员），但实际业务逻辑是：
- **人员是通过模块参与项目的**
- 人员 → 加入模块（`ModuleAssignment`） → 模块属于项目（`ProjectModule`）
- 比如：张三在A项目的B模块中，那么张三就是参与了A项目

## 🔧 修复方案

### 正确的统计逻辑
1. 找到用户参与的所有模块（通过 `ModuleAssignment` 表）
2. 找到这些模块对应的项目（通过 `ProjectModule` 表）
3. 对项目去重，统计不重复的项目数量

### 示例说明
假设张三的情况：
- 参与了 A项目 的 B模块
- 参与了 A项目 的 C模块  
- 参与了 D项目 的 E模块

那么张三参与的项目数应该是 **2个**（A项目和D项目），而不是3个模块。

## 📝 具体修改

### 文件：`backend/services/user_service.py`

#### 1. 导入必要的模型类（第7行）
```python
from ..models.database import db, User, ProjectMember, Project, UserRole, ProjectMemberRole, ModuleAssignment, ProjectModule
```

#### 2. 修改获取用户列表的统计逻辑（第93-108行）

**修改前：**
```python
# 添加参与项目数量
project_count = ProjectMember.query.filter_by(user_id=user.id).count()
user_dict['project_count'] = project_count
```

**修改后：**
```python
# 统计参与项目数量：通过模块参与统计
# 1. 找到用户参与的所有模块
module_assignments = ModuleAssignment.query.filter_by(user_id=user.id).all()
module_ids = [assignment.module_id for assignment in module_assignments]

# 2. 找到这些模块对应的项目（去重）
if module_ids:
    project_ids = db.session.query(ProjectModule.project_id)\
        .filter(ProjectModule.id.in_(module_ids))\
        .distinct()\
        .all()
    project_count = len(project_ids)
else:
    project_count = 0

user_dict['project_count'] = project_count
```

#### 3. 优化删除用户时的检查逻辑（第418-446行）

**修改前：**
```python
# 检查用户是否还参与项目
project_count = ProjectMember.query.filter_by(user_id=user_id).count()
if project_count > 0:
    return {
        'success': False,
        'message': f'用户还参与 {project_count} 个项目，无法删除。请先从所有项目中移除该用户。',
        'data': None
    }
```

**修改后：**
```python
# 检查用户是否还参与模块（即参与项目）
module_assignment_count = ModuleAssignment.query.filter_by(user_id=user_id).count()
if module_assignment_count > 0:
    # 统计参与的项目数量用于提示
    module_assignments = ModuleAssignment.query.filter_by(user_id=user_id).all()
    module_ids = [assignment.module_id for assignment in module_assignments]
    if module_ids:
        project_ids = db.session.query(ProjectModule.project_id)\
            .filter(ProjectModule.id.in_(module_ids))\
            .distinct()\
            .all()
        project_count = len(project_ids)
    else:
        project_count = 0
        
    return {
        'success': False,
        'message': f'用户还参与 {project_count} 个项目的 {module_assignment_count} 个模块，无法删除。请先从所有模块中移除该用户。',
        'data': None
    }

# 检查用户是否是项目负责人
leader_count = ProjectMember.query.filter_by(user_id=user_id, role=ProjectMemberRole.LEADER).count()
if leader_count > 0:
    return {
        'success': False,
        'message': f'用户还负责 {leader_count} 个项目，无法删除。请先更换项目负责人。',
        'data': None
    }
```

## 🔍 数据库关系说明

### 相关表结构

#### ModuleAssignment（模块分配表）
```python
class ModuleAssignment(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    module_id = db.Column(db.Integer, db.ForeignKey('project_modules.id'))
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    role = db.Column(db.String(50), default='member')
```

#### ProjectModule（项目模块表）
```python
class ProjectModule(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    project_id = db.Column(db.Integer, db.ForeignKey('projects.id'))
    name = db.Column(db.String(200))
    assigned_to_id = db.Column(db.Integer, db.ForeignKey('users.id'))
```

#### ProjectMember（项目成员表）
```python
class ProjectMember(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    project_id = db.Column(db.Integer, db.ForeignKey('projects.id'))
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    role = db.Column(db.Enum(ProjectMemberRole))  # LEADER/MEMBER
```

### 数据流向图
```
用户（User）
    ↓ 通过 ModuleAssignment
模块（ProjectModule）
    ↓ 属于
项目（Project）
    ↓ 通过 ProjectMember（仅负责人角色）
项目负责人统计
```

## ✅ 修复效果

### 统计准确性
1. ✅ "参与项目"数量现在正确反映用户实际参与的项目数
2. ✅ 即使用户在同一项目的多个模块中，也只计算一次
3. ✅ 删除用户时的检查更加全面和准确

### 用户体验
1. ✅ 删除用户时会明确提示参与的项目数和模块数
2. ✅ 区分"参与项目"和"负责项目"两个概念
3. ✅ 提示信息更加详细和友好

## 🧪 测试建议

### 测试场景

#### 场景1：单项目多模块
- 张三参与了项目A的模块1和模块2
- 预期结果：参与项目数 = 1

#### 场景2：多项目多模块
- 张三参与了项目A的模块1、项目B的模块2
- 预期结果：参与项目数 = 2

#### 场景3：项目负责人
- 张三是项目A的负责人（ProjectMember.role = LEADER）
- 预期结果：负责项目数 = 1

#### 场景4：删除用户
- 张三参与了2个项目的3个模块
- 尝试删除时应提示："用户还参与 2 个项目的 3 个模块，无法删除"

## 📊 性能考虑

### 查询优化
```python
# 使用 distinct() 去重，避免重复计算
project_ids = db.session.query(ProjectModule.project_id)\
    .filter(ProjectModule.id.in_(module_ids))\
    .distinct()\
    .all()
```

### 可能的优化方向
1. **缓存统计结果**：如果用户列表经常访问，可以考虑缓存
2. **批量查询**：获取用户列表时可以优化为批量查询
3. **数据库索引**：确保 `module_id` 和 `user_id` 有索引

## 🔄 后端服务重启

修改后需要重启后端服务以使更改生效：

```bash
# 停止旧进程
pkill -f "python.*app.py"

# 启动新进程
cd backend
source venv/bin/activate
nohup python app.py > ../backend.log 2>&1 &
```

## 📝 相关API

### GET /api/users
返回用户列表，包含：
- `project_count`: 参与项目数量（修复后）
- `leader_count`: 负责项目数量

### DELETE /api/users/{user_id}
删除用户前会检查：
1. 是否参与任何模块
2. 是否是任何项目的负责人

## 🎯 业务逻辑总结

### 两种角色关系
1. **项目参与者**：通过模块参与项目（ModuleAssignment）
   - 体现在模块分配中
   - 统计："参与项目"数量

2. **项目负责人**：直接关联到项目（ProjectMember，role=LEADER）
   - 体现在项目成员中
   - 统计："负责项目"数量

### 关键区别
- **参与** = 在项目的任何模块中工作
- **负责** = 作为项目的负责人角色

---

**修复完成时间**：2025-11-03  
**影响文件**：`backend/services/user_service.py`  
**后端状态**：已重启并生效  
**建议测试**：在人员管理页面验证统计数据的准确性

