# 编辑项目负责人显示修复说明

## 修复时间
2025年11月4日

## 问题描述
在编辑项目时，项目负责人字段没有显示原有的负责人，而是显示为空。

---

## 问题原因分析

### 后端返回的数据结构
```javascript
{
  id: 1,
  name: "测试项目",
  members: [
    {
      id: 1,           // ← 用户ID
      name: "张三",
      role: "leader",
      position: "工程师"
    }
  ]
}
```

### 前端原有的取值逻辑
```javascript
// ❌ 错误的字段名
form.leader = leader.user_id || leader.user?.id || ''
```

**问题**：后端返回的成员对象中，用户ID字段是 `id`，不是 `user_id`！

---

## 修复方案

### 修复前 ❌
```javascript
// 从项目成员中找到负责人
if (props.project.members && props.project.members.length > 0) {
  const leader = props.project.members.find(m => m.role === 'leader')
  if (leader) {
    form.leader = leader.user_id || leader.user?.id || ''  // ← 字段名错误
  }
}
```

### 修复后 ✅
```javascript
// 从项目成员中找到负责人
if (props.project.members && props.project.members.length > 0) {
  const leader = props.project.members.find(m => m.role === 'leader')
  if (leader) {
    // 后端返回的成员对象中 id 字段就是用户ID
    form.leader = leader.id || ''  // ← 直接使用 id 字段
  }
}
```

---

## 修复内容

### 1. 字段映射修正
| 错误字段 | 正确字段 | 说明 |
|---------|---------|------|
| `leader.user_id` | `leader.id` | 后端成员对象的用户ID字段 |
| `leader.user?.id` | ~~不需要~~ | 已经是用户对象，不需要嵌套 |

### 2. 代码简化
- 移除了不必要的多重取值逻辑
- 直接使用 `leader.id` 获取用户ID
- 代码更清晰易懂

---

## 数据流程说明

```
┌─────────────────────────────────────────────────┐
│ 后端 ProjectService.get_project_list()         │
│                                                 │
│ for member in project.members:                 │
│   member_info = {                               │
│     'id': member.user.id,      ← 用户ID        │
│     'name': member.user.name,                   │
│     'role': member.role.value,                  │
│     'position': member.user.position            │
│   }                                             │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│ 前端 Projects.vue                               │
│                                                 │
│ const showEditProject = (project) => {          │
│   selectedProject.value = project  ← 包含members│
│   editDialogVisible.value = true                │
│ }                                               │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│ 前端 EditProjectDialog.vue                      │
│                                                 │
│ const leader = props.project.members            │
│   .find(m => m.role === 'leader')               │
│                                                 │
│ form.leader = leader.id  ← 正确提取用户ID       │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│ 表单显示                                        │
│                                                 │
│ 项目负责人: [张三 (工程师)] ✅ 显示正确          │
└─────────────────────────────────────────────────┘
```

---

## 测试验证

### 测试步骤
1. 创建一个新项目，选择"张三"作为项目负责人
2. 保存后，点击该项目的"编辑"按钮
3. 检查项目负责人字段

### 预期结果
- ✅ 项目负责人字段应该显示"张三 (工程师)"
- ✅ 下拉框中应该高亮显示当前选中的负责人
- ✅ 修改负责人后应该能正常保存

### 测试场景

#### 场景1：有负责人的项目
```
项目：测试项目A
负责人：张三
结果：编辑时显示 "张三 (工程师)" ✅
```

#### 场景2：多个成员但有明确负责人
```
项目：测试项目B
成员：张三(leader)、李四(member)、王五(member)
结果：编辑时显示 "张三 (工程师)" ✅
```

#### 场景3：创建时就设置负责人
```
操作：创建项目 → 选择负责人 → 保存 → 编辑
结果：编辑时负责人应该正确回显 ✅
```

---

## 相关代码位置

### 修改的文件
- ✅ `frontend/src/components/EditProjectDialog.vue`

### 相关代码片段

**后端数据构造**（无需修改）：
```120:134:backend/services/project_service.py
for member in project.members:
    member_info = {
        'id': member.user.id,
        'name': member.user.name,
        'role': member.role.value,
        'position': member.user.position
    }
    members.append(member_info)
    
    if member.role == ProjectMemberRole.LEADER:
        leaders.append(member_info)

project_dict['members'] = members
project_dict['leaders'] = leaders
```

**前端数据提取**（已修复）：
```316:323:frontend/src/components/EditProjectDialog.vue
// 从项目成员中找到负责人
if (props.project.members && props.project.members.length > 0) {
  const leader = props.project.members.find(m => m.role === 'leader')
  if (leader) {
    // 后端返回的成员对象中 id 字段就是用户ID
    form.leader = leader.id || ''
  }
}
```

---

## 总结

### 问题本质
前后端字段名不一致导致的数据提取失败。

### 解决方式
- 调整前端代码以匹配后端返回的数据结构
- 使用 `leader.id` 而不是 `leader.user_id`

### 影响范围
- ✅ 编辑项目时负责人字段正确显示
- ✅ 不影响其他功能
- ✅ 代码更简洁

### 安全性
- ✅ 无安全问题
- ✅ 数据完整性得到保证
- ✅ 用户体验提升

---

*修复完成于 2025年11月4日*

