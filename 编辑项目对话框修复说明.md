# 编辑项目对话框修复说明

## 🐛 问题描述

### 问题1：纵向项目无法编辑合作方
- **现象**：编辑纵向项目时，合作方字段不显示
- **期望**：纵向项目也应该可以填写和编辑合作方

### 问题2：纵向项目状态选项错误
- **现象**：编辑纵向项目时，状态下拉框显示的是横向项目的10个状态
- **期望**：纵向项目应该显示4个专用状态（申报阶段、审核阶段、审核通过、审核未通过）

---

## ✅ 解决方案

### 1. 合作方字段显示修复

#### 修改前
```vue
<!-- 合作方（仅横向项目显示） -->
<el-form-item v-if="form.project_source === 'horizontal'" label="合作方" prop="partner">
  <el-input
    v-model="form.partner"
    placeholder="请输入合作方名称"
  />
</el-form-item>
```

**问题**：只有 `horizontal` 时才显示，纵向项目无法编辑

#### 修改后
```vue
<!-- 合作方（横向和纵向项目显示） -->
<el-form-item 
  v-if="form.project_source === 'horizontal' || form.project_source === 'vertical'" 
  label="合作方" 
  prop="partner"
>
  <el-input
    v-model="form.partner"
    placeholder="请输入合作方名称（选填）"
    maxlength="100"
    show-word-limit
  />
</el-form-item>
```

**改进**：
- ✅ 横向和纵向项目都显示合作方字段
- ✅ 自研项目不显示（自研不需要合作方）

---

### 2. 纵向项目状态选项修复

#### 修改前
```vue
<el-form-item label="项目状态" prop="status">
  <el-select v-model="form.status" placeholder="选择项目状态">
    <!-- 横向和纵向项目的状态 -->
    <template v-if="form.project_source === 'horizontal' || form.project_source === 'vertical'">
      <el-option label="初步接触" value="initial_contact" />
      <!-- ... 10个横向状态 -->
    </template>
  </el-select>
</el-form-item>
```

**问题**：横向和纵向项目共用同一套状态，纵向显示错误

#### 修改后
```vue
<el-form-item label="项目状态" prop="status">
  <el-select v-model="form.status" placeholder="选择项目状态">
    <!-- 横向项目的状态 -->
    <template v-if="form.project_source === 'horizontal'">
      <el-option label="初步接触" value="initial_contact" />
      <el-option label="提交方案" value="proposal_submitted" />
      <!-- ... 10个横向状态 -->
    </template>
    
    <!-- 纵向项目专用状态 -->
    <template v-else-if="form.project_source === 'vertical'">
      <el-option label="申报阶段" value="vertical_declaration" />
      <el-option label="审核阶段" value="vertical_review" />
      <el-option label="审核通过" value="vertical_approved" />
      <el-option label="审核未通过" value="vertical_rejected" />
    </template>
    
    <!-- 自研项目的状态 -->
    <template v-else-if="form.project_source === 'self_developed'">
      <el-option label="进行中" value="project_implementation" />
      <el-option label="已完成" value="project_acceptance" />
    </template>
  </el-select>
</el-form-item>
```

**改进**：
- ✅ 横向项目：10个状态
- ✅ 纵向项目：4个专用状态
- ✅ 自研项目：2个状态

---

### 3. 项目类型切换逻辑优化

#### 修改前
```javascript
const handleProjectSourceChange = (source) => {
  if (source === 'self_developed') {
    form.status = 'project_implementation'
    form.partner = ''
  } else if (/* 复杂的状态判断 */) {
    form.status = 'initial_contact'
  }
}
```

**问题**：
- 没有处理纵向项目的状态切换
- 逻辑复杂，难以维护

#### 修改后
```javascript
const handleProjectSourceChange = (source) => {
  if (source === 'self_developed') {
    // 自研项目默认为进行中
    form.status = 'project_implementation'
    form.partner = '' // 清空合作方
  } else if (source === 'vertical') {
    // 纵向项目
    const verticalStatuses = ['vertical_declaration', 'vertical_review', 
                             'vertical_approved', 'vertical_rejected']
    if (!verticalStatuses.includes(form.status)) {
      form.status = 'vertical_declaration' // 默认申报阶段
    }
    // 保留合作方
  } else if (source === 'horizontal') {
    // 横向项目
    const horizontalStatuses = ['initial_contact', 'proposal_submitted', 
                               /* ... */]
    if (!horizontalStatuses.includes(form.status)) {
      form.status = 'initial_contact' // 默认初步接触
    }
    // 保留合作方
  }
}
```

**改进**：
- ✅ 清晰的三分支逻辑
- ✅ 每个项目类型都有明确的状态验证
- ✅ 只在切换到自研时清空合作方
- ✅ 横向和纵向切换时保留合作方

---

## 📊 修复对比表

| 功能 | 修复前 | 修复后 |
|------|--------|--------|
| **横向项目合作方** | ✅ 显示 | ✅ 显示 |
| **纵向项目合作方** | ❌ 不显示 | ✅ 显示 |
| **自研项目合作方** | ✅ 不显示 | ✅ 不显示 |
| **横向项目状态** | ✅ 10个横向状态 | ✅ 10个横向状态 |
| **纵向项目状态** | ❌ 10个横向状态 | ✅ 4个纵向状态 |
| **自研项目状态** | ✅ 2个自研状态 | ✅ 2个自研状态 |
| **切换类型逻辑** | ❌ 逻辑混乱 | ✅ 清晰明确 |

---

## 🎯 使用场景

### 场景1：编辑纵向项目
1. 在项目列表中点击"编辑"纵向项目
2. **验证**：
   - ✅ 合作方字段显示，可以编辑
   - ✅ 状态下拉框显示4个纵向专用状态
   - ✅ 当前状态正确显示
3. 修改合作方和状态
4. 保存成功

### 场景2：切换项目类型（横向→纵向）
1. 编辑一个横向项目
2. 切换项目类型为"纵向"
3. **验证**：
   - ✅ 合作方字段继续显示（保留原值）
   - ✅ 状态下拉框变为4个纵向状态
   - ✅ 如果原状态不是纵向状态，自动切换为"申报阶段"

### 场景3：切换项目类型（纵向→自研）
1. 编辑一个纵向项目
2. 切换项目类型为"自研"
3. **验证**：
   - ✅ 合作方字段隐藏（自研不需要）
   - ✅ 合作方值被清空
   - ✅ 状态下拉框变为2个自研状态
   - ✅ 状态自动切换为"进行中"

---

## 🔧 技术细节

### 状态验证逻辑

**横向项目状态列表**：
```javascript
const horizontalStatuses = [
  'initial_contact',         // 初步接触
  'proposal_submitted',      // 提交方案
  'quotation_submitted',     // 提交报价
  'user_confirmation',       // 用户确认
  'contract_signed',         // 合同签订
  'project_implementation',  // 项目实施
  'project_acceptance',      // 项目验收
  'warranty_period',         // 维保期内
  'post_warranty',           // 维保期外
  'no_follow_up'            // 不再跟进
]
```

**纵向项目状态列表**：
```javascript
const verticalStatuses = [
  'vertical_declaration',    // 申报阶段
  'vertical_review',         // 审核阶段
  'vertical_approved',       // 审核通过
  'vertical_rejected'        // 审核未通过
]
```

### 状态切换规则

```
切换到自研：
  - 任何状态 → 'project_implementation'
  - 合作方 → 清空

切换到纵向：
  - 如果当前是纵向状态 → 保持
  - 否则 → 'vertical_declaration'
  - 合作方 → 保留

切换到横向：
  - 如果当前是横向状态 → 保持
  - 否则 → 'initial_contact'
  - 合作方 → 保留
```

---

## 📝 修改文件清单

### 前端文件（1个）

**`frontend/src/components/EditProjectDialog.vue`**

#### 修改内容：
1. **合作方字段显示条件**（第33-41行）
   - `v-if="form.project_source === 'horizontal'"`
   - → `v-if="form.project_source === 'horizontal' || form.project_source === 'vertical'"`

2. **状态选项模板**（第66-95行）
   - 分离横向和纵向的状态选项
   - 添加纵向专用的4个状态

3. **项目类型切换逻辑**（第230-259行）
   - 重构为清晰的三分支结构
   - 添加纵向状态验证
   - 优化合作方保留/清空逻辑

---

## 🧪 测试步骤

### 测试1：编辑纵向项目
1. 进入"项目管理"页面
2. 找到一个纵向项目
3. 点击"编辑"按钮
4. **验证**：
   - ✅ 合作方字段显示
   - ✅ 状态下拉框显示纵向4个状态
   - ✅ 当前状态正确回填
5. 修改合作方和状态
6. 点击"保存修改"
7. **验证**：保存成功，数据正确更新

### 测试2：类型切换
1. 编辑一个横向项目
2. 切换类型为"纵向"
3. **验证**：
   - ✅ 状态下拉框变为纵向状态
   - ✅ 合作方保留
4. 切换类型为"自研"
5. **验证**：
   - ✅ 状态下拉框变为自研状态
   - ✅ 合作方字段隐藏
6. 切换类型为"横向"
7. **验证**：
   - ✅ 状态下拉框变为横向状态
   - ✅ 合作方字段显示（值为空）

### 测试3：状态保持
1. 编辑一个状态为"审核阶段"的纵向项目
2. 切换到其他选项卡后返回
3. **验证**：状态仍为"审核阶段"
4. 不修改，直接保存
5. **验证**：状态保持不变

---

## 🎨 UI效果

### 编辑横向项目
```
┌─────────────────────────────────┐
│ 编辑项目                        │
├─────────────────────────────────┤
│ 项目名称: [横向项目A        ]   │
│ 项目类型: [横向 ▼]              │
│ 合作方:   [某公司           ] ✅ │
│ 状态:     [初步接触 ▼]      ✅  │
│           - 初步接触             │
│           - 提交方案             │
│           - ...（10个状态）      │
└─────────────────────────────────┘
```

### 编辑纵向项目
```
┌─────────────────────────────────┐
│ 编辑项目                        │
├─────────────────────────────────┤
│ 项目名称: [纵向项目B        ]   │
│ 项目类型: [纵向 ▼]              │
│ 合作方:   [某大学           ] ✅ │
│ 状态:     [申报阶段 ▼]      ✅  │
│           - 申报阶段             │
│           - 审核阶段             │
│           - 审核通过             │
│           - 审核未通过           │
└─────────────────────────────────┘
```

### 编辑自研项目
```
┌─────────────────────────────────┐
│ 编辑项目                        │
├─────────────────────────────────┤
│ 项目名称: [自研项目C        ]   │
│ 项目类型: [自研 ▼]              │
│ （合作方字段不显示）        ✅   │
│ 状态:     [进行中 ▼]        ✅  │
│           - 进行中               │
│           - 已完成               │
└─────────────────────────────────┘
```

---

## ✅ 完成清单

- [x] 合作方字段支持纵向项目
- [x] 纵向项目显示专用状态选项
- [x] 优化项目类型切换逻辑
- [x] 状态验证和自动切换
- [x] 合作方保留/清空逻辑优化
- [x] Linter检查通过
- [x] 文档编写完成

---

## 🎉 修复完成

**所有问题已解决！** ✅

**现在编辑纵向项目时：**
- ✅ 可以编辑合作方
- ✅ 状态下拉框显示4个纵向专用状态
- ✅ 切换项目类型时逻辑正确

**刷新页面后即可测试！** 🎨

---

**完成时间**：2025-11-03  
**修复文件**：1个  
**修复问题**：2个  
**影响功能**：项目编辑

