# 数据恢复说明

## 问题描述

在执行项目金额字段迁移时（`migrate_update_project_fields.py`），由于 SQLite 不支持直接删除列，需要重建表。在重建表的过程中，数据复制逻辑出现问题，导致项目数据丢失。

**症状**：
- 项目列表显示为空（0个项目）
- 但人员管理中仍显示参与项目数量（因为 `module_assignments` 表未受影响）

## 问题原因

迁移脚本在删除 `priority` 字段时需要重建表，但在数据复制过程中出现了字段名不匹配的问题：
- 脚本已经将 `amount` 重命名为 `contract_amount`
- 但在复制数据时仍尝试从旧表的 `amount` 字段读取
- 导致数据复制失败，项目数据丢失

## 解决方案

### 1. 从备份恢复

幸运的是，`backend/project_management.db` 中保留了迁移前的完整数据（2025-11-03 17:06）。

**恢复步骤**：
```bash
# 1. 复制备份到数据目录
cp backend/project_management.db data/project_management.db

# 2. 重新执行迁移（已修复）
cd backend
python3 migrate_update_project_fields.py
```

### 2. 验证数据

```bash
sqlite3 data/project_management.db "
SELECT 
  (SELECT COUNT(*) FROM users) as users,
  (SELECT COUNT(*) FROM projects) as projects,
  (SELECT COUNT(*) FROM project_modules) as modules,
  (SELECT COUNT(*) FROM module_assignments) as assignments;
"
```

**预期结果**：
```
10|11|19|36
```

### 3. 检查字段

```bash
sqlite3 data/project_management.db "PRAGMA table_info(projects);"
```

**应包含的字段**：
- ✅ `contract_amount` （合同金额）
- ✅ `received_amount` （到账金额）
- ❌ `priority` （已删除）
- ❌ `amount` （已重命名为 contract_amount）

## 数据恢复脚本

创建了两个恢复脚本（虽然最终没有使用，但保留以备后用）：

### 1. `restore_data.py`
从 `database_export.json` 恢复数据的通用脚本。

### 2. `import_local.py`
专门用于本地环境的数据导入脚本，包含用户确认步骤。

**注意**：这两个脚本遇到了 Flask-SQLAlchemy 上下文问题，最终采用直接复制备份数据库的方式解决。

## 预防措施

### 1. 自动备份

在执行任何数据库迁移前，自动创建备份：

```python
import shutil
from datetime import datetime

# 在迁移脚本开头添加
backup_file = f"{db_path}.backup.{datetime.now().strftime('%Y%m%d_%H%M%S')}"
shutil.copy2(db_path, backup_file)
print(f"✅ 已创建备份: {backup_file}")
```

### 2. 测试迁移

在测试数据库上先执行迁移：

```bash
# 复制数据库
cp data/project_management.db data/project_management_test.db

# 在测试数据库上执行迁移
# 修改迁移脚本的 db_path 指向测试数据库

# 验证结果
sqlite3 data/project_management_test.db "SELECT COUNT(*) FROM projects;"
```

### 3. 分步迁移

将复杂的迁移分成多个步骤：

1. **第一步**：重命名字段
2. **第二步**：添加新字段
3. **第三步**：删除旧字段

每步都验证数据完整性。

### 4. 使用事务

确保迁移脚本使用事务，失败时可以回滚：

```python
try:
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    # 执行迁移操作
    cursor.execute("...")
    
    # 提交
    conn.commit()
except Exception as e:
    # 回滚
    conn.rollback()
    raise
finally:
    conn.close()
```

## 经验教训

1. **SQLite 的限制**：SQLite 不支持直接删除列，需要重建表，这个过程容易出错
2. **备份的重要性**：多个位置保留备份（`backend/`, `data/`, `database_export.json`）救了我们
3. **测试的必要性**：应该在测试环境先执行迁移
4. **分步执行**：复杂的迁移应该分成多个小步骤
5. **数据验证**：每步都应该验证数据完整性

## 当前状态

- ✅ 数据已完全恢复（10用户, 11项目, 19模块, 36分配）
- ✅ 字段已正确迁移（contract_amount, received_amount）
- ✅ priority 字段已删除
- ✅ 应用可以正常使用

## 后续建议

1. **导出最新数据**：
```bash
cd backend
python3 export_database.py
```

2. **测试功能**：
   - 创建新项目（测试合同金额和到账金额）
   - 编辑现有项目
   - 查看项目列表
   - 验证人员管理中的项目统计

3. **推送到 Render**：
   - 先推送代码更改
   - 等待自动部署
   - 数据会自动从 `database_export.json` 导入

---

**恢复时间**：2025-11-04 08:55  
**数据来源**：backend/project_management.db (2025-11-03 17:06)  
**恢复状态**：✅ 成功

