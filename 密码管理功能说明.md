# 密码管理功能说明

## 修改时间
2025年11月4日

## 功能概述
新增了用户密码管理功能，包括：
1. **用户修改密码** - 所有用户可以修改自己的密码
2. **主管重置密码** - 部门主管可以重置任何用户的密码为初始密码

同时优化了项目详情页的成员卡片显示。

---

## 一、项目成员卡片优化

### ✅ 修改内容
删除了项目成员卡片中的"参与模块"显示

### 修改前
```
┌──────────────┐
│ [张] 张三     │
│ 软件工程师    │
│ 参与模块:     │  ← 删除
│ 前端、后端    │  ← 删除
└──────────────┘
```

### 修改后
```
┌──────────────┐
│ [张] 张三     │
│ 软件工程师    │
└──────────────┘
```

**修改文件**：
- `frontend/src/views/ProjectDetail.vue`

**原因**：
- 简化成员卡片显示
- 成员信息更简洁清晰
- 减少冗余信息

---

## 二、用户修改密码功能

### ✅ 功能说明
所有登录用户都可以修改自己的密码

### 入口位置
**用户下拉菜单** → **修改密码**

```
┌─────────────────┐
│ [张] 张三        │
│ 软件工程师       │
│ ▼               │
├─────────────────┤
│ 修改密码  ← 新增 │
│ ─────────────── │
│ 退出登录         │
└─────────────────┘
```

### 功能流程

#### 1. 打开修改密码对话框
- 点击用户下拉菜单中的"修改密码"
- 弹出修改密码对话框

#### 2. 填写密码信息
```
┌─────────────────────────┐
│      修改密码            │
├─────────────────────────┤
│ 旧密码: [__________]    │
│ 新密码: [__________]    │  ← 至少6位
│ 确认密码: [__________]  │
├─────────────────────────┤
│ [取消]  [确认修改]      │
└─────────────────────────┘
```

#### 3. 密码验证规则
- ✅ 旧密码必须正确
- ✅ 新密码不能为空
- ✅ 新密码长度至少6位
- ✅ 两次输入的新密码必须一致

#### 4. 修改成功
- 提示："密码修改成功，请重新登录"
- 3秒后自动跳转到登录页
- 需要用新密码重新登录

### API接口

**端点**：`PUT /api/users/change-password`

**请求体**：
```json
{
  "old_password": "旧密码",
  "new_password": "新密码"
}
```

**响应**：
```json
{
  "success": true,
  "message": "密码修改成功",
  "data": null
}
```

**错误情况**：
- 旧密码不正确：`{"success": false, "message": "旧密码不正确"}`
- 新密码太短：`{"success": false, "message": "新密码长度不能少于6位"}`

---

## 三、主管重置密码功能

### ✅ 功能说明
部门主管可以将任何用户的密码重置为初始密码 `td123456`

### 权限要求
- ✅ 只有 `supervisor` (部门主管) 角色可以使用
- ❌ 普通成员(`member`)无此权限

### 入口位置
**人员管理页面** → **操作列** → **重置密码**

```
人员管理
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
姓名    职位        操作
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
张三    软件工程师   [查看详情] [编辑] [重置密码] [删除]
                                    ↑ 新增
李四    产品经理     [查看详情] [编辑] [重置密码] [删除]
```

### 功能流程

#### 1. 点击重置密码按钮
- 在人员管理页面，每个用户后面都有"重置密码"按钮
- 只有部门主管能看到此按钮

#### 2. 确认重置
```
┌─────────────────────────────────────┐
│        确认重置密码                  │
├─────────────────────────────────────┤
│ 确定要将用户 "张三" 的密码重置为      │
│ 初始密码 "td123456" 吗？             │
├─────────────────────────────────────┤
│ [取消]  [确定]                       │
└─────────────────────────────────────┘
```

#### 3. 重置成功
显示重置后的登录信息：
```
┌─────────────────────────┐
│    密码重置成功          │
├─────────────────────────┤
│ 用户名: zhangsan        │
│ 初始密码: td123456      │
├─────────────────────────┤
│ [确定]                  │
└─────────────────────────┘
```

#### 4. 通知用户
- 主管需要将新密码告知用户
- 用户使用初始密码登录后，建议修改密码

### API接口

**端点**：`PUT /api/users/{user_id}/reset-password`

**权限**：`supervisor`（部门主管）

**响应**：
```json
{
  "success": true,
  "message": "密码已重置为初始密码: td123456",
  "data": {
    "username": "zhangsan",
    "password": "td123456"
  }
}
```

**错误情况**：
- 无权限：`{"success": false, "message": "只有部门主管才能重置密码"}`
- 用户不存在：`{"success": false, "message": "用户不存在"}`

---

## 四、技术实现

### 后端实现

#### 1. 用户控制器 (user_controller.py)

**修改密码接口**：
```python
@user_bp.route('/change-password', methods=['PUT'])
@login_required
def change_password():
    """用户修改自己的密码"""
    # 验证旧密码
    # 设置新密码
    # 返回成功
```

**重置密码接口**：
```python
@user_bp.route('/<int:user_id>/reset-password', methods=['PUT'])
@login_required
def reset_password(user_id):
    """部门主管重置用户密码为初始密码"""
    # 检查权限（只有supervisor）
    # 重置为 td123456
    # 返回新密码
```

#### 2. 用户服务 (user_service.py)

**修改密码**：
```python
@staticmethod
def change_password(user_id, old_password, new_password):
    # 验证旧密码
    if not user.check_password(old_password):
        return error
    
    # 设置新密码
    user.set_password(new_password)
    db.session.commit()
```

**重置密码**：
```python
@staticmethod
def reset_password(user_id):
    # 设置为初始密码
    initial_password = 'td123456'
    user.set_password(initial_password)
    db.session.commit()
    
    return {
        'username': user.username,
        'password': initial_password
    }
```

### 前端实现

#### 1. API接口 (api.js)
```javascript
// 修改密码
changePassword(data) {
  return api.put('/users/change-password', data)
}

// 重置密码
resetPassword(userId) {
  return api.put(`/users/${userId}/reset-password`)
}
```

#### 2. 修改密码对话框组件
**文件**：`frontend/src/components/ChangePasswordDialog.vue`

**功能**：
- 表单验证
- 密码确认
- 修改成功后跳转登录页

#### 3. 主布局组件集成
**文件**：`frontend/src/layout/MainLayout.vue`

**修改**：
- 用户下拉菜单添加"修改密码"选项
- 集成修改密码对话框

#### 4. 人员管理页面
**文件**：`frontend/src/views/Users.vue`

**修改**：
- 操作列添加"重置密码"按钮
- 实现重置密码确认和提示

---

## 五、使用场景

### 场景1：用户首次登录后修改密码
1. 使用初始密码登录（td123456）
2. 点击右上角用户菜单 → 修改密码
3. 输入旧密码和新密码
4. 修改成功后重新登录

### 场景2：用户忘记密码
1. 用户联系部门主管
2. 主管进入"人员管理"页面
3. 找到该用户，点击"重置密码"
4. 确认重置
5. 将新密码（td123456）告知用户
6. 用户使用初始密码登录
7. 建议用户修改密码

### 场景3：定期修改密码（安全建议）
1. 用户定期（如每3个月）修改密码
2. 点击用户菜单 → 修改密码
3. 完成密码修改

---

## 六、安全考虑

### 密码存储
- ✅ 密码使用bcrypt哈希存储
- ✅ 不存储明文密码
- ✅ 每次修改都重新哈希

### 权限控制
- ✅ 用户只能修改自己的密码
- ✅ 重置密码需要supervisor权限
- ✅ API层和服务层双重权限验证

### 密码强度
- ✅ 最小长度6位
- ⚠️ 建议未来增加复杂度要求：
  - 包含大小写字母
  - 包含数字
  - 包含特殊字符

### 初始密码
- ⚠️ 初始密码固定为 `td123456`
- ✅ 建议用户首次登录后立即修改
- ✅ 重置后也需要尽快修改

---

## 七、文件清单

### 后端文件
- ✅ `backend/controllers/user_controller.py` - 添加2个API端点
- ✅ `backend/services/user_service.py` - 添加2个服务方法

### 前端文件
- ✅ `frontend/src/utils/api.js` - 添加2个API方法
- ✅ `frontend/src/components/ChangePasswordDialog.vue` - 新增组件
- ✅ `frontend/src/layout/MainLayout.vue` - 集成修改密码功能
- ✅ `frontend/src/views/Users.vue` - 添加重置密码按钮
- ✅ `frontend/src/views/ProjectDetail.vue` - 删除参与模块显示

### 文档文件
- ✅ `密码管理功能说明.md` - 本文档

---

## 八、测试建议

### 1. 修改密码功能测试

#### 测试用例1：正常修改密码
- [ ] 登录系统
- [ ] 点击用户菜单 → 修改密码
- [ ] 输入正确的旧密码
- [ ] 输入新密码（至少6位）
- [ ] 确认密码一致
- [ ] 点击确认修改
- [ ] 验证：提示成功，自动跳转登录页
- [ ] 使用新密码重新登录

#### 测试用例2：旧密码错误
- [ ] 输入错误的旧密码
- [ ] 验证：提示"旧密码不正确"

#### 测试用例3：新密码太短
- [ ] 输入少于6位的新密码
- [ ] 验证：提示"密码长度不能少于6位"

#### 测试用例4：确认密码不一致
- [ ] 新密码和确认密码不同
- [ ] 验证：提示"两次输入的密码不一致"

### 2. 重置密码功能测试

#### 测试用例1：主管重置密码
- [ ] 使用主管账号登录
- [ ] 进入人员管理页面
- [ ] 点击某用户的"重置密码"按钮
- [ ] 确认重置
- [ ] 验证：显示用户名和初始密码
- [ ] 使用被重置用户的账号和初始密码登录
- [ ] 验证：能够成功登录

#### 测试用例2：普通成员无权限
- [ ] 使用普通成员账号登录
- [ ] 验证：人员管理菜单不可见
- [ ] 或直接访问API
- [ ] 验证：返回403权限错误

#### 测试用例3：重置不存在的用户
- [ ] 使用不存在的用户ID调用API
- [ ] 验证：提示"用户不存在"

### 3. 项目成员卡片测试
- [ ] 打开任意项目详情页
- [ ] 查看项目成员卡片
- [ ] 验证：不显示"参与模块"信息
- [ ] 验证：只显示姓名和职位

---

## 九、常见问题

### Q1: 修改密码后需要重新登录吗？
**A**: 是的。为了安全考虑，修改密码成功后会自动跳转到登录页，需要使用新密码重新登录。

### Q2: 初始密码是什么？
**A**: 初始密码固定为 `td123456`。用户首次登录或密码被重置后，都使用这个密码。

### Q3: 普通成员可以重置别人的密码吗？
**A**: 不可以。只有部门主管（supervisor）才能重置密码。普通成员只能修改自己的密码。

### Q4: 如果忘记密码怎么办？
**A**: 联系部门主管，由主管在人员管理页面重置您的密码为初始密码 `td123456`，然后您可以重新登录并修改密码。

### Q5: 密码有复杂度要求吗？
**A**: 目前只要求最小长度6位。建议使用包含数字、字母的组合密码，提高安全性。

### Q6: 重置密码后用户会收到通知吗？
**A**: 目前不会自动通知。部门主管重置后需要手动告知用户新密码。未来可以考虑添加邮件通知功能。

---

## 十、未来优化建议

### 短期优化（1-2周）
1. **密码强度验证**
   - 添加密码复杂度要求
   - 实时显示密码强度

2. **密码历史**
   - 记录密码修改历史
   - 防止重复使用旧密码

### 中期优化（1-2个月）
1. **邮件通知**
   - 重置密码后发送邮件通知
   - 修改密码后发送邮件确认

2. **找回密码功能**
   - 通过邮箱找回密码
   - 发送重置链接

3. **密码过期机制**
   - 设置密码有效期（如90天）
   - 到期前提醒用户修改

### 长期优化（3个月+）
1. **两步验证**
   - 支持短信验证码
   - 支持邮箱验证码

2. **单点登录**
   - 集成企业SSO
   - 支持OAuth登录

3. **操作日志**
   - 记录密码修改日志
   - 记录登录失败日志
   - 异常行为检测

---

## 十一、总结

本次更新新增了完整的密码管理功能：

### 用户功能
- ✅ 修改自己的密码
- ✅ 安全的密码验证
- ✅ 友好的操作提示

### 主管功能
- ✅ 重置任何用户密码
- ✅ 查看重置后的密码
- ✅ 权限严格控制

### 界面优化
- ✅ 项目成员卡片更简洁
- ✅ 用户菜单添加修改密码入口
- ✅ 人员管理添加重置密码按钮

### 技术实现
- ✅ 后端API完整
- ✅ 前端组件完善
- ✅ 权限控制严格
- ✅ 安全性考虑周全

**整体评价**：⭐⭐⭐⭐⭐

---

*功能完成于 2025年11月4日*

