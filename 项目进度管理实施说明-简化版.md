# 项目进度管理实施说明 - 简化版

## 完成时间
2025年11月4日

---

## ✅ 已完成的工作

### 后端实现（100%完成）

#### 1. 数据库迁移
- ✅ 创建 `migrate_add_manual_progress.py`
- ✅ 添加 `manual_progress` 字段到 projects 表

#### 2. 进度计算逻辑
- ✅ 更新 `calculate_project_progress()` 方法
- ✅ 支持三种进度来源：模块 > 手动 > 默认
- ✅ 前期阶段模块进度映射到阶段范围
- ✅ 项目实施阶段基于模块计算（35% + 模块平均 × 65%）

#### 3. 新增服务方法
- ✅ `get_progress_limits(status)` - 获取进度范围
- ✅ `update_manual_progress(project_id, progress)` - 更新手动进度

#### 4. API路由
- ✅ `PUT /api/projects/{id}/manual-progress` - 更新手动进度

#### 5. 数据重置脚本
- ✅ 创建 `migrate_reset_all_progress.py`
- ✅ 可一键重置所有项目进度

### 前端实现（API已完成）

#### 1. API方法
- ✅ `projectApi.updateManualProgress(id, progress)`

---

## 📊 核心功能说明

### 进度计算优先级

```
1. 有模块？
   ├─ 是 → 基于模块进度计算
   │        前期阶段：映射到阶段范围（5-15%等）
   │        实施阶段：35% + 模块平均 × 65%
   │
   └─ 否 → 2. 有手动进度？
           ├─ 是 → 使用手动进度（需在范围内）
           └─ 否 → 使用状态默认进度
```

### 阶段进度范围

| 状态 | 范围 | 默认 |
|------|------|------|
| 初步接触 | 0-5% | 5% |
| 提交方案 | 5-15% | 15% |
| 提交报价 | 15-20% | 20% |
| 用户确认 | 20-25% | 25% |
| 合同签订 | 25-35% | 35% |

### 模块进度映射示例

**场景**：提交方案阶段（范围 5-15%），有3个模块

```python
模块进度：80%, 60%, 40%
模块平均：(80 + 60 + 40) / 3 = 60%

阶段范围：15 - 5 = 10%
项目进度：5 + (60 / 100 × 10) = 5 + 6 = 11%

结果：项目进度 = 11% ✅
```

---

## 🚀 部署步骤

### Step 1: 执行数据库迁移

```bash
cd backend
python migrate_add_manual_progress.py
```

### Step 2: 重置项目进度（可选）

```bash
python migrate_reset_all_progress.py
# 输入 yes 确认
```

### Step 3: 重启后端服务

```bash
# 如果使用开发服务器
python app.py

# 或使用 gunicorn
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

### Step 4: 测试API

```bash
# 测试更新手动进度
curl -X PUT http://localhost:5000/api/projects/1/manual-progress \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"progress": 10}'
```

---

## 📝 前端集成（待完成）

### 需要创建的组件

`frontend/src/components/UpdateProgressDialog.vue`

**关键功能**：
1. 根据项目状态显示进度范围
2. 如果有模块，显示模块进度映射说明
3. 如果没有模块，提供滑块选择手动进度
4. 验证进度范围
5. 调用 API 更新进度

### 集成到项目详情页

在 `ProjectDetail.vue` 中添加"更新进度"按钮：
- 仅在前期阶段显示
- 点击打开进度编辑对话框
- 更新成功后刷新项目数据

---

## 🧪 测试用例

### 测试1：前期阶段，无模块，手动设置

```
项目：测试项目A
状态：提交方案（范围 5-15%）
模块：无
操作：手动设置进度为 10%
预期：成功，进度显示 10%
```

### 测试2：前期阶段，有模块，自动映射

```
项目：测试项目B
状态：提交方案（范围 5-15%）
模块：3个（80%, 60%, 40%）
操作：无需手动设置
预期：进度自动计算为 11%
```

### 测试3：手动设置超出范围

```
项目：测试项目C
状态：提交方案（范围 5-15%）
操作：尝试设置进度为 20%
预期：失败，提示"进度不能超过15%"
```

### 测试4：项目实施阶段

```
项目：测试项目D
状态：项目实施
模块：3个（100%, 60%, 30%）
预期：进度自动计算为 76%（35% + 63.3% × 65%）
```

---

## 📁 修改的文件清单

### 后端
- ✅ `backend/migrate_add_manual_progress.py` - 新建
- ✅ `backend/migrate_reset_all_progress.py` - 新建
- ✅ `backend/services/project_service.py` - 修改
  - 新增 `get_progress_limits()`
  - 重构 `calculate_project_progress()`
  - 新增 `update_manual_progress()`
- ✅ `backend/controllers/project_controller.py` - 修改
  - 新增 `/manual-progress` 路由

### 前端
- ✅ `frontend/src/utils/api.js` - 修改
  - 新增 `updateManualProgress()` 方法
- ⏳ `frontend/src/components/UpdateProgressDialog.vue` - 待创建
- ⏳ `frontend/src/views/ProjectDetail.vue` - 待集成

---

## ⚠️ 重要提醒

### 1. 进度计算优先级
**模块优先**：如果项目有模块，进度会基于模块自动计算，手动进度会被忽略。

### 2. 前期阶段模块映射
前期阶段的模块进度会**线性映射**到阶段范围，不是直接使用模块进度值。

### 3. 数据重置
执行重置脚本会清空所有 `manual_progress`，根据新逻辑重新计算。建议在业务低峰期执行。

### 4. 测试建议
先在测试环境验证，确认无误后再部署到生产环境。

---

## 🎯 下一步工作

### 立即可做
1. ✅ 执行数据库迁移
2. ✅ 执行进度重置
3. ✅ 重启后端测试API

### 需要补充
1. ⏳ 前端进度编辑对话框组件
2. ⏳ 集成到项目详情页
3. ⏳ UI/UX优化

---

## 💡 使用示例

### 场景1：前期项目，没有模块

**用户操作**：
1. 进入项目详情页
2. 点击"更新进度"
3. 拖动滑块选择进度（范围受限）
4. 保存

**系统行为**：
- 保存到 `manual_progress` 字段
- 项目进度显示为手动设置的值

### 场景2：前期项目，有模块

**用户操作**：
1. 更新模块进度

**系统行为**：
- 自动计算模块平均进度
- 映射到当前阶段范围
- 项目进度自动更新
- `manual_progress` 被忽略

### 场景3：实施阶段项目

**用户操作**：
1. 更新模块进度

**系统行为**：
- 计算：35% + (模块平均 × 65%)
- 项目进度自动更新
- 不允许手动设置

---

*实施完成于 2025年11月4日*

