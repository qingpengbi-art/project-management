# 纵向项目状态改造说明

## 改造概述

纵向项目的业务逻辑与横向项目不同，需要特殊的状态系统。主要改动包括：

1. **纵向项目有专用状态**：申报阶段、审核阶段、审核通过、审核未通过
2. **纵向项目没有进度概念**：不再使用0-100%的进度值，进度固定为0
3. **创建和编辑流程调整**：纵向项目在创建/编辑时使用专用状态选项，隐藏进度字段
4. **显示逻辑调整**：所有显示纵向项目的地方不再显示进度相关信息

## 详细改动

### 1. 后端改动

#### 1.1 数据模型 (`backend/models/database.py`)

**添加纵向项目专用状态**：

```python
class ProjectStatus(Enum):
    """项目状态枚举 - 业务流程状态"""
    # 横向项目状态
    INITIAL_CONTACT = "initial_contact"        # 初步接触
    PROPOSAL_SUBMITTED = "proposal_submitted"   # 提交方案
    QUOTATION_SUBMITTED = "quotation_submitted" # 提交报价
    USER_CONFIRMATION = "user_confirmation"     # 用户确认
    CONTRACT_SIGNED = "contract_signed"         # 合同签订
    PROJECT_IMPLEMENTATION = "project_implementation" # 项目实施
    PROJECT_ACCEPTANCE = "project_acceptance"   # 项目验收
    WARRANTY_PERIOD = "warranty_period"        # 维保期内
    POST_WARRANTY = "post_warranty"            # 维保期外
    NO_FOLLOW_UP = "no_follow_up"             # 不再跟进
    
    # 纵向项目专用状态 ✨ 新增
    VERTICAL_DECLARATION = "vertical_declaration"     # 申报阶段
    VERTICAL_REVIEW = "vertical_review"               # 审核阶段
    VERTICAL_APPROVED = "vertical_approved"           # 审核通过
    VERTICAL_REJECTED = "vertical_rejected"           # 审核未通过
```

#### 1.2 项目服务 (`backend/services/project_service.py`)

**修改1：创建项目时，纵向项目进度固定为0**

```python
def create_project(project_data: Dict[str, Any]) -> Dict[str, Any]:
    try:
        project_source = project_data.get('project_source', 'horizontal')
        
        project = Project(
            # ... 其他字段 ...
            project_source=project_source,
            progress=0 if project_source == 'vertical' else project_data.get('progress', 0)  # ✨ 纵向项目进度固定为0
        )
```

**修改2：禁止纵向项目更新进度**

```python
def update_project_progress(project_id: int, progress_data: Dict[str, Any]) -> Dict[str, Any]:
    try:
        project = Project.query.get(project_id)
        
        # ✨ 纵向项目不允许更新进度
        if project.project_source == 'vertical':
            return {
                'success': False,
                'message': '纵向项目没有进度概念，不允许更新进度',
                'data': None
            }
        
        # ... 横向项目的进度更新逻辑 ...
```

### 2. 前端改动

#### 2.1 状态映射 (`frontend/src/stores/project.js`)

**添加纵向项目状态文本映射**：

```javascript
const getStatusText = (status) => {
  const statusMap = {
    // 横向项目状态
    'initial_contact': '初步接触',
    'proposal_submitted': '提交方案',
    // ... 其他横向状态 ...
    
    // 纵向项目专用状态 ✨ 新增
    'vertical_declaration': '申报阶段',
    'vertical_review': '审核阶段',
    'vertical_approved': '审核通过',
    'vertical_rejected': '审核未通过'
  }
  return statusMap[status] || status
}
```

**添加纵向项目状态颜色映射**：

```javascript
const getStatusColor = (status) => {
  const colorMap = {
    // 横向项目状态颜色
    // ... 横向状态颜色 ...
    
    // 纵向项目状态颜色 ✨ 新增
    'vertical_declaration': '#5AC8FA',   // 天蓝色 - 申报阶段
    'vertical_review': '#FF9500',        // 橙色 - 审核阶段
    'vertical_approved': '#34C759',      // 绿色 - 审核通过
    'vertical_rejected': '#FF3B30'       // 红色 - 审核未通过
  }
  return colorMap[status] || '#8e8e93'
}
```

#### 2.2 创建项目对话框 (`frontend/src/components/CreateProjectDialog.vue`)

**需要的改动**（待实现）：

1. **根据项目类型显示不同的状态选项**
   ```vue
   <!-- 横向项目显示横向状态 -->
   <el-select v-if="form.project_source === 'horizontal'" v-model="form.status">
     <el-option value="initial_contact" label="初步接触" />
     <el-option value="proposal_submitted" label="提交方案" />
     <!-- ... 其他横向状态 ... -->
   </el-select>
   
   <!-- 纵向项目显示纵向专用状态 ✨ -->
   <el-select v-else-if="form.project_source === 'vertical'" v-model="form.status">
     <el-option value="vertical_declaration" label="申报阶段" />
     <el-option value="vertical_review" label="审核阶段" />
     <el-option value="vertical_approved" label="审核通过" />
     <el-option value="vertical_rejected" label="审核未通过" />
   </el-select>
   ```

2. **纵向项目隐藏进度字段**
   ```vue
   <!-- 只在横向项目显示进度字段 ✨ -->
   <el-form-item v-if="form.project_source === 'horizontal'" label="初始进度" prop="progress">
     <el-slider v-model="form.progress" :min="0" :max="100" show-input />
   </el-form-item>
   ```

#### 2.3 项目详情页 (`frontend/src/views/ProjectDetail.vue`)

**需要的改动**（待实现）：

- 纵向项目不显示进度条
- 纵向项目不显示"更新进度"按钮
- 状态标签使用纵向专用状态文本

```vue
<!-- 只在横向项目显示进度 -->
<div v-if="project.project_source === 'horizontal'" class="progress-section">
  <el-progress :percentage="project.progress" />
</div>
```

#### 2.4 Dashboard (`frontend/src/views/Dashboard.vue`)

**需要的改动**（待实现）：

- 纵向项目卡片不显示"平均进度"
- 纵向项目统计不显示进度信息
- 状态统计使用纵向专用状态

#### 2.5 项目列表 (`frontend/src/views/Projects.vue`)

**需要的改动**（待实现）：

- 纵向项目卡片不显示进度圆环
- 纵向项目显示纵向专用状态标签

### 3. 数据库迁移

由于添加了新的状态枚举值，现有纵向项目需要迁移到新状态。

**迁移策略**：

```python
# 迁移脚本建议
# 将现有纵向项目的状态映射到新状态

status_migration = {
    'initial_contact': 'vertical_declaration',      # 初步接触 → 申报阶段
    'proposal_submitted': 'vertical_declaration',   # 提交方案 → 申报阶段
    'quotation_submitted': 'vertical_review',       # 提交报价 → 审核阶段
    'user_confirmation': 'vertical_review',         # 用户确认 → 审核阶段
    'contract_signed': 'vertical_approved',         # 合同签订 → 审核通过
    'project_implementation': 'vertical_approved',  # 项目实施 → 审核通过
    'project_acceptance': 'vertical_approved',      # 项目验收 → 审核通过
    'no_follow_up': 'vertical_rejected',           # 不再跟进 → 审核未通过
}
```

## 状态对照表

### 纵向项目新状态

| 状态值 | 中文名称 | 颜色 | 说明 |
|--------|---------|------|------|
| `vertical_declaration` | 申报阶段 | 天蓝色 #5AC8FA | 项目处于申报准备阶段 |
| `vertical_review` | 审核阶段 | 橙色 #FF9500 | 项目正在审核中 |
| `vertical_approved` | 审核通过 | 绿色 #34C759 | 项目审核通过，可以开始执行 |
| `vertical_rejected` | 审核未通过 | 红色 #FF3B30 | 项目审核未通过 |

### 横向项目状态（保持不变）

| 状态值 | 中文名称 |
|--------|---------|
| `initial_contact` | 初步接触 |
| `proposal_submitted` | 提交方案 |
| `quotation_submitted` | 提交报价 |
| `user_confirmation` | 用户确认 |
| `contract_signed` | 合同签订 |
| `project_implementation` | 项目实施 |
| `project_acceptance` | 项目验收 |
| `warranty_period` | 维保期内 |
| `post_warranty` | 维保期外 |
| `no_follow_up` | 不再跟进 |

## 进度字段处理

### 横向项目
- **有进度概念**：0-100%
- 可以创建、更新进度
- 显示进度条、进度百分比

### 纵向项目
- **没有进度概念**
- 进度字段固定为0（数据库中保留，但前端不显示）
- 不允许更新进度
- 状态变化不依赖进度

## 实施计划

### 已完成 ✅
1. 后端：添加纵向项目专用状态枚举
2. 后端：创建项目时纵向项目进度固定为0
3. 后端：禁止纵向项目更新进度
4. 前端：状态文本和颜色映射

### 待完成 🚧
1. 前端：CreateProjectDialog - 根据项目类型显示不同状态选项
2. 前端：CreateProjectDialog - 纵向项目隐藏进度字段
3. 前端：EditProjectDialog - 同样处理
4. 前端：ProjectDetail - 纵向项目不显示进度相关内容
5. 前端：Dashboard - 纵向项目卡片调整
6. 前端：Projects列表 - 纵向项目卡片调整
7. 数据库：迁移现有纵向项目到新状态
8. 测试：全面测试纵向项目的创建、编辑、显示

## 兼容性说明

### 数据库
- 现有字段不变，只是添加新的枚举值
- `progress` 字段保留但纵向项目固定为0
- 需要运行迁移脚本更新现有纵向项目的状态

### API
- 后端API保持向后兼容
- 纵向项目调用更新进度API会返回错误提示
- 状态字段接受新的纵向专用状态值

### 前端
- 使用 `project_source` 字段判断项目类型
- 根据项目类型动态显示/隐藏进度相关UI
- 使用统一的 `getStatusText` 和 `getStatusColor` 方法

## 使用示例

### 创建纵向项目

```javascript
const verticalProject = {
  name: "科研项目申报",
  project_source: "vertical",
  status: "vertical_declaration",  // 使用纵向专用状态
  // progress: 0  // 自动设置为0，前端不需要传
}
```

### 判断是否显示进度

```vue
<template>
  <!-- 只在横向项目显示进度 -->
  <div v-if="project.project_source === 'horizontal'" class="progress-info">
    <el-progress :percentage="project.progress" />
  </div>
  
  <!-- 纵向项目显示状态 -->
  <div v-else class="status-info">
    <el-tag :type="getStatusType(project.status)">
      {{ getStatusText(project.status) }}
    </el-tag>
  </div>
</template>
```

## 注意事项

1. **不要删除progress字段**：虽然纵向项目不使用，但为了保持数据库结构统一，字段保留
2. **状态迁移要谨慎**：在生产环境运行迁移脚本前务必备份数据库
3. **前端需要完整测试**：确保所有显示项目的地方都正确处理了纵向项目
4. **用户体验**：纵向项目的状态流程要清晰明确，避免用户困惑

## 后续优化建议

1. **状态流转控制**：可以限制纵向项目的状态只能按照特定流程变更
2. **权限细化**：不同角色对纵向项目状态的修改权限可以不同
3. **通知提醒**：当纵向项目状态变更时发送通知
4. **统计报表**：专门为纵向项目设计统计维度

---

**文档创建时间**：2025-11-03  
**作者**：AI Assistant  
**状态**：部分完成，前端UI调整待实现

