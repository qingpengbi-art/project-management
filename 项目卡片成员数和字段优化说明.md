# 项目卡片成员数和字段优化说明

## 修复时间
2025年11月5日

## 问题描述

### 问题1：项目卡片成员数显示错误
在项目管理页面的项目卡片上，所有项目的成员数都显示为1人，但实际上项目成员数量在项目详情页面的项目成员卡片里都有正确的数据。

**原因分析：**
- 后端在计算成员数时，使用的是`project.members`（项目级别的成员关系表）
- 但实际的项目成员应该从**模块分配**中收集（就像项目详情页面那样）
- 项目详情页面通过遍历所有模块的`assigned_users`来收集真实的项目成员

### 问题2：项目类型字段重复显示
在项目卡片上有一个"项目类型"字段，但这个信息在卡片右上角已经用标签形式展示了，造成信息重复。

## 修复方案

### 1. 修复成员数计算逻辑（后端）

**文件：** `backend/services/project_service.py`

**修改位置：** `get_project_list` 方法（第385-423行）

**修改内容：**
```python
# 从模块中收集真实的项目成员（去重）
module_members = {}
project_modules = ProjectModule.query.filter_by(project_id=project.id).all()
for module in project_modules:
    # 获取模块分配的成员
    assignments = ModuleAssignment.query.filter_by(module_id=module.id).all()
    for assignment in assignments:
        user = assignment.user
        if user.id not in module_members:
            module_members[user.id] = {
                'id': user.id,
                'name': user.name,
                'position': user.position
            }

project_dict['members'] = members
project_dict['leaders'] = leaders
# 成员数量使用从模块中收集的实际成员数
project_dict['member_count'] = len(module_members)
```

**修改说明：**
- 遍历项目的所有模块
- 从每个模块的分配记录中收集成员
- 使用字典去重，确保同一个成员只计数一次
- 最终`member_count`反映的是实际参与项目的成员数量

### 2. 删除重复的项目类型字段（前端）

**文件：** `frontend/src/views/Projects.vue`

**修改位置：** 项目卡片的项目信息部分（第162-179行）

**删除内容：**
```vue
<!-- 删除了这个重复的字段 -->
<div class="info-row">
  <span class="info-label">项目类型:</span>
  <span class="info-value">{{ getSourceText(project.project_source) }}</span>
</div>
```

**保留内容：**
- 卡片右上角的项目类型标签（第109-111行）
- 负责人信息
- 合作方信息（仅横向项目显示）
- 成员数
- 更新时间

## 修改后的项目卡片信息结构

```
┌─────────────────────────────────────┐
│ [项目名称]          [横向] [状态]  │  ← 项目类型标签在右上角
├─────────────────────────────────────┤
│ 项目描述                            │
├─────────────────────────────────────┤
│ 进度：[进度圆环]                    │
├─────────────────────────────────────┤
│ 负责人：XXX                         │
│ 合作方：XXX (仅横向项目)            │
│ 成员数：N人  ← 现在显示真实成员数   │
│ 更新时间：YYYY-MM-DD                │
├─────────────────────────────────────┤
│ [编辑项目] [删除项目] [查看详情]    │
└─────────────────────────────────────┘
```

## 数据流程

### 成员数计算流程：
1. 项目包含多个模块
2. 每个模块通过`ModuleAssignment`分配给多个成员
3. 后端遍历所有模块，收集所有被分配的用户
4. 去重后统计唯一用户数量
5. 返回真实的项目成员数

### 与项目详情页保持一致：
项目详情页面也是通过相同的逻辑计算成员：
```javascript
// frontend/src/views/ProjectDetail.vue (第301-328行)
const allProjectMembers = computed(() => {
  const memberMap = new Map()
  modules.value.forEach(module => {
    if (module.assigned_users && module.assigned_users.length > 0) {
      module.assigned_users.forEach(user => {
        if (!memberMap.has(user.id)) {
          memberMap.set(user.id, {...})
        }
      })
    }
  })
  return Array.from(memberMap.values())
})
```

## 测试建议

1. **成员数测试：**
   - 查看项目管理页面，检查每个项目卡片的成员数
   - 点击查看详情，对比项目成员卡片显示的实际成员数
   - 两者应该一致

2. **项目类型显示测试：**
   - 确认项目卡片右上角显示项目类型标签（横向/纵向/自研）
   - 确认项目信息区域不再重复显示项目类型字段
   - 界面应该更简洁清晰

3. **不同项目类型测试：**
   - 横向项目：显示合作方字段
   - 纵向项目：不显示合作方字段
   - 自研项目：不显示合作方字段

## 注意事项

1. **性能考虑：**
   - 成员数计算需要查询模块和分配记录
   - 如果项目数量很多，可能需要优化查询（例如使用JOIN或缓存）

2. **数据一致性：**
   - 成员数现在反映的是**实际参与项目的成员**（从模块分配中统计）
   - 而不是项目级别的成员关系表（`project.members`用于存储负责人等角色）

3. **未来优化方向：**
   - 可以考虑在数据库层面添加计算字段或触发器
   - 在模块分配变更时自动更新项目的成员数缓存

## 影响范围

- ✅ 项目管理页面（Projects.vue）
- ✅ 后端项目服务（project_service.py）
- ✅ 项目列表API返回数据
- ⚠️ Dashboard页面可能需要同步更新（如果也显示成员数）

## 完成状态

- [x] 修复后端成员数计算逻辑
- [x] 删除前端重复的项目类型字段
- [x] 代码无语法错误
- [x] 创建修复说明文档

