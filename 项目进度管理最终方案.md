# é¡¹ç›®è¿›åº¦ç®¡ç†æœ€ç»ˆæ–¹æ¡ˆ

## å®æ–½æ—¶é—´
2025å¹´11æœˆ4æ—¥

---

## ä¸€ã€æ ¸å¿ƒè§„åˆ™

### 1.1 è¿›åº¦æ¥æºä¼˜å…ˆçº§

```
è¿›åº¦è®¡ç®—ä¼˜å…ˆçº§ï¼š
1. å¦‚æœæœ‰æ¨¡å— â†’ åŸºäºæ¨¡å—è¿›åº¦è®¡ç®—ï¼ˆ35% + æ¨¡å—å¹³å‡ Ã— 65%ï¼‰
2. å¦‚æœæ²¡æœ‰æ¨¡å— â†’ ä½¿ç”¨æ‰‹åŠ¨è¿›åº¦ï¼ˆåœ¨å…è®¸èŒƒå›´å†…ï¼‰
3. å¦‚æœæ²¡æœ‰æ‰‹åŠ¨è¿›åº¦ â†’ ä½¿ç”¨çŠ¶æ€é»˜è®¤è¿›åº¦
```

### 1.2 ä¸åŒé˜¶æ®µçš„è§„åˆ™

#### å‰æœŸé˜¶æ®µï¼ˆåˆæ­¥æ¥è§¦ â†’ åˆåŒç­¾è®¢ï¼‰

| çŠ¶æ€ | é»˜è®¤è¿›åº¦ | å…è®¸èŒƒå›´ | æ˜¯å¦å¯æœ‰æ¨¡å— |
|------|---------|---------|-------------|
| åˆæ­¥æ¥è§¦ | 5% | 0-5% | âœ… å¯ä»¥ |
| æäº¤æ–¹æ¡ˆ | 15% | 5-15% | âœ… å¯ä»¥ |
| æäº¤æŠ¥ä»· | 20% | 15-20% | âœ… å¯ä»¥ |
| ç”¨æˆ·ç¡®è®¤ | 25% | 20-25% | âœ… å¯ä»¥ |
| åˆåŒç­¾è®¢ | 35% | 25-35% | âœ… å¯ä»¥ |

**è§„åˆ™**ï¼š
- âœ… å¯ä»¥æ‰‹åŠ¨è®¾ç½®è¿›åº¦ï¼ˆåœ¨èŒƒå›´å†…ï¼‰
- âœ… å¯ä»¥åˆ›å»ºæ¨¡å—
- âœ… **å¦‚æœæœ‰æ¨¡å—ï¼Œæ¨¡å—è¿›åº¦ä¼˜å…ˆ**
- âœ… è¿›åº¦ä¸èƒ½ä½äºå‰ä¸€é˜¶æ®µä¸Šé™
- âœ… è¿›åº¦ä¸èƒ½è¶…è¿‡å½“å‰é˜¶æ®µä¸Šé™

#### é¡¹ç›®å®æ–½é˜¶æ®µ

| çŠ¶æ€ | è®¡ç®—æ–¹å¼ | æ˜¯å¦å¯æ‰‹åŠ¨ | æ˜¯å¦å¯æœ‰æ¨¡å— |
|------|---------|-----------|-------------|
| é¡¹ç›®å®æ–½ | 35% + (æ¨¡å—å¹³å‡ Ã— 65%) | âŒ ä¸å¯ä»¥ | âœ… å¿…é¡»æœ‰ |

**è§„åˆ™**ï¼š
- âŒ ä¸å…è®¸æ‰‹åŠ¨è®¾ç½®è¿›åº¦
- âœ… å¿…é¡»é€šè¿‡æ¨¡å—è¿›åº¦åæ˜ 
- âœ… å¦‚æœæ²¡æœ‰æ¨¡å—ï¼Œæ˜¾ç¤ºå›ºå®š70%

#### å®Œæˆ/ç»´ä¿é˜¶æ®µ

| çŠ¶æ€ | è¿›åº¦ | æ˜¯å¦å¯ä¿®æ”¹ |
|------|------|-----------|
| é¡¹ç›®éªŒæ”¶ | 100% | âŒ ä¸å¯ä»¥ |
| ç»´ä¿æœŸå†… | 100% | âŒ ä¸å¯ä»¥ |
| ç»´ä¿æœŸå¤– | 100% | âŒ ä¸å¯ä»¥ |
| ä¸å†è·Ÿè¿› | 0% | âŒ ä¸å¯ä»¥ |

---

## äºŒã€è¿›åº¦è®¡ç®—é€»è¾‘

### 2.1 å®Œæ•´è®¡ç®—æµç¨‹

```javascript
function calculateProjectProgress(project) {
  const status = project.status
  const modules = project.modules
  const manualProgress = project.manual_progress  // æ‰‹åŠ¨è®¾ç½®çš„è¿›åº¦
  
  // 1. å®Œæˆ/ç»ˆæ­¢çŠ¶æ€ï¼šå›ºå®šè¿›åº¦
  if (status in ['project_acceptance', 'warranty_period', 'post_warranty']) {
    return { progress: 100, type: 'completed', source: 'status' }
  }
  if (status === 'no_follow_up') {
    return { progress: 0, type: 'terminated', source: 'status' }
  }
  
  // 2. é¡¹ç›®å®æ–½é˜¶æ®µï¼šå¿…é¡»åŸºäºæ¨¡å—
  if (status === 'project_implementation') {
    if (modules.length > 0) {
      const avgModuleProgress = calculateModuleAverage(modules)
      const finalProgress = 35 + (avgModuleProgress * 0.65)
      return { 
        progress: Math.round(finalProgress), 
        type: 'implementation',
        source: 'modules',
        moduleCount: modules.length,
        avgModuleProgress: Math.round(avgModuleProgress)
      }
    } else {
      return { 
        progress: 70, 
        type: 'implementation',
        source: 'default',
        info: 'æœªè®¾ç½®æ¨¡å—'
      }
    }
  }
  
  // 3. å‰æœŸé˜¶æ®µï¼šä¼˜å…ˆçº§ æ¨¡å— > æ‰‹åŠ¨ > é»˜è®¤
  if (status in ['initial_contact', 'proposal_submitted', 'quotation_submitted',
                 'user_confirmation', 'contract_signed']) {
    
    // 3.1 å¦‚æœæœ‰æ¨¡å—ï¼ŒåŸºäºæ¨¡å—è®¡ç®—
    if (modules.length > 0) {
      const limits = getProgressLimits(status)
      const avgModuleProgress = calculateModuleAverage(modules)
      
      // å°†æ¨¡å—è¿›åº¦æ˜ å°„åˆ°å½“å‰é˜¶æ®µçš„èŒƒå›´
      const rangeSize = limits.max - limits.min
      const mappedProgress = limits.min + (avgModuleProgress / 100 * rangeSize)
      
      return {
        progress: Math.round(mappedProgress),
        type: 'stage_with_modules',
        source: 'modules',
        moduleCount: modules.length,
        avgModuleProgress: Math.round(avgModuleProgress),
        info: `åŸºäº ${modules.length} ä¸ªæ¨¡å—ï¼Œæ˜ å°„åˆ°é˜¶æ®µèŒƒå›´ ${limits.min}-${limits.max}%`
      }
    }
    
    // 3.2 å¦‚æœæœ‰æ‰‹åŠ¨è¿›åº¦ï¼Œä½¿ç”¨æ‰‹åŠ¨è¿›åº¦
    if (manualProgress !== null && manualProgress !== undefined) {
      const limits = getProgressLimits(status)
      
      // éªŒè¯èŒƒå›´
      if (manualProgress < limits.min || manualProgress > limits.max) {
        return {
          progress: limits.default,
          type: 'stage',
          source: 'default',
          error: `æ‰‹åŠ¨è¿›åº¦ ${manualProgress}% è¶…å‡ºèŒƒå›´ ${limits.min}-${limits.max}%`
        }
      }
      
      return {
        progress: manualProgress,
        type: 'stage_manual',
        source: 'manual',
        info: 'æ‰‹åŠ¨è®¾ç½®'
      }
    }
    
    // 3.3 ä½¿ç”¨é»˜è®¤è¿›åº¦
    const limits = getProgressLimits(status)
    return {
      progress: limits.default,
      type: 'stage',
      source: 'default',
      stage: limits.stage,
      info: 'é˜¶æ®µé»˜è®¤è¿›åº¦'
    }
  }
  
  return { progress: 0, type: 'unknown', source: 'error' }
}
```

### 2.2 è¿›åº¦èŒƒå›´å®šä¹‰

```javascript
const PROGRESS_LIMITS = {
  'initial_contact': { 
    min: 0, 
    max: 5, 
    default: 5, 
    stage: 1,
    label: 'åˆæ­¥æ¥è§¦' 
  },
  'proposal_submitted': { 
    min: 5, 
    max: 15, 
    default: 15, 
    stage: 2,
    label: 'æäº¤æ–¹æ¡ˆ' 
  },
  'quotation_submitted': { 
    min: 15, 
    max: 20, 
    default: 20, 
    stage: 3,
    label: 'æäº¤æŠ¥ä»·' 
  },
  'user_confirmation': { 
    min: 20, 
    max: 25, 
    default: 25, 
    stage: 4,
    label: 'ç”¨æˆ·ç¡®è®¤' 
  },
  'contract_signed': { 
    min: 25, 
    max: 35, 
    default: 35, 
    stage: 5,
    label: 'åˆåŒç­¾è®¢' 
  }
}
```

---

## ä¸‰ã€æ¨¡å—è¿›åº¦æ˜ å°„è§„åˆ™

### 3.1 å‰æœŸé˜¶æ®µçš„æ¨¡å—è¿›åº¦æ˜ å°„

**é—®é¢˜**ï¼šå¦‚æœ"æäº¤æ–¹æ¡ˆ"é˜¶æ®µçš„èŒƒå›´æ˜¯5-15%ï¼Œæ¨¡å—è¿›åº¦å¦‚ä½•æ˜ å°„ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼šçº¿æ€§æ˜ å°„

```
æ¨¡å—å¹³å‡è¿›åº¦ 0%   â†’ é¡¹ç›®è¿›åº¦ 5%  (é˜¶æ®µä¸‹é™)
æ¨¡å—å¹³å‡è¿›åº¦ 50%  â†’ é¡¹ç›®è¿›åº¦ 10% (é˜¶æ®µä¸­é—´)
æ¨¡å—å¹³å‡è¿›åº¦ 100% â†’ é¡¹ç›®è¿›åº¦ 15% (é˜¶æ®µä¸Šé™)

å…¬å¼ï¼š
é¡¹ç›®è¿›åº¦ = é˜¶æ®µä¸‹é™ + (æ¨¡å—å¹³å‡è¿›åº¦ / 100 Ã— é˜¶æ®µèŒƒå›´)
         = min + (avgModuleProgress / 100 Ã— (max - min))
```

**ç¤ºä¾‹**ï¼š

#### åœºæ™¯1ï¼šæäº¤æ–¹æ¡ˆé˜¶æ®µï¼Œæœ‰3ä¸ªæ¨¡å—
```
çŠ¶æ€ï¼šæäº¤æ–¹æ¡ˆ
å…è®¸èŒƒå›´ï¼š5-15%
æ¨¡å—è¿›åº¦ï¼š
  - æ–¹æ¡ˆæ’°å†™ï¼š80%
  - æ–¹æ¡ˆè¯„å®¡ï¼š60%
  - æ–¹æ¡ˆæäº¤ï¼š40%

è®¡ç®—ï¼š
  æ¨¡å—å¹³å‡ï¼š(80 + 60 + 40) / 3 = 60%
  é˜¶æ®µèŒƒå›´ï¼š15 - 5 = 10%
  æ˜ å°„è¿›åº¦ï¼š5 + (60 / 100 Ã— 10) = 5 + 6 = 11%

ç»“æœï¼šé¡¹ç›®è¿›åº¦ = 11% âœ…
```

#### åœºæ™¯2ï¼šåˆæ­¥æ¥è§¦é˜¶æ®µï¼Œæœ‰2ä¸ªæ¨¡å—
```
çŠ¶æ€ï¼šåˆæ­¥æ¥è§¦
å…è®¸èŒƒå›´ï¼š0-5%
æ¨¡å—è¿›åº¦ï¼š
  - å®¢æˆ·æ²Ÿé€šï¼š100%
  - éœ€æ±‚äº†è§£ï¼š80%

è®¡ç®—ï¼š
  æ¨¡å—å¹³å‡ï¼š(100 + 80) / 2 = 90%
  é˜¶æ®µèŒƒå›´ï¼š5 - 0 = 5%
  æ˜ å°„è¿›åº¦ï¼š0 + (90 / 100 Ã— 5) = 0 + 4.5 = 4.5%

ç»“æœï¼šé¡¹ç›®è¿›åº¦ = 5% (å››èˆäº”å…¥) âœ…
```

### 3.2 é¡¹ç›®å®æ–½é˜¶æ®µçš„æ¨¡å—è¿›åº¦

**å…¬å¼ä¿æŒä¸å˜**ï¼š
```
é¡¹ç›®è¿›åº¦ = 35% + (æ¨¡å—å¹³å‡è¿›åº¦ Ã— 65%)
```

è¿™ä¸ªå…¬å¼å·²ç»å®ç°ï¼Œä¸éœ€è¦ä¿®æ”¹ã€‚

---

## å››ã€æ•°æ®åº“è®¾è®¡

### 4.1 æ–°å¢å­—æ®µ

```sql
ALTER TABLE projects ADD COLUMN manual_progress INTEGER DEFAULT NULL;
-- manual_progress: ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®çš„è¿›åº¦ï¼ˆä»…å‰æœŸé˜¶æ®µæœ‰æ•ˆï¼‰
-- NULL è¡¨ç¤ºæœªæ‰‹åŠ¨è®¾ç½®
```

### 4.2 å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ä½•æ—¶ä½¿ç”¨ |
|------|------|------|---------|
| `progress` | INTEGER | ç³»ç»Ÿè®¡ç®—çš„è¿›åº¦ | åªè¯»ï¼Œç”±ç³»ç»Ÿè®¡ç®— |
| `manual_progress` | INTEGER | æ‰‹åŠ¨è®¾ç½®çš„è¿›åº¦ | å‰æœŸé˜¶æ®µå¯è®¾ç½® |
| `status` | VARCHAR | é¡¹ç›®çŠ¶æ€ | å½±å“è¿›åº¦èŒƒå›´ |

---

## äº”ã€API è®¾è®¡

### 5.1 æ›´æ–°æ‰‹åŠ¨è¿›åº¦

```python
@project_bp.route('/<int:project_id>/manual-progress', methods=['PUT'])
@login_required
def update_manual_progress(project_id):
    """
    æ›´æ–°é¡¹ç›®çš„æ‰‹åŠ¨è¿›åº¦
    ä»…é€‚ç”¨äºå‰æœŸé˜¶æ®µï¼ˆåˆæ­¥æ¥è§¦ â†’ åˆåŒç­¾è®¢ï¼‰
    """
    try:
        data = request.get_json()
        progress = data.get('progress')
        
        if progress is None:
            return jsonify({
                'success': False,
                'message': 'è¿›åº¦å€¼ä¸èƒ½ä¸ºç©º',
                'data': None
            }), 400
        
        result = ProjectService.update_manual_progress(project_id, progress)
        
        if result['success']:
            return jsonify(result), 200
        else:
            return jsonify(result), 400
            
    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'æ›´æ–°è¿›åº¦å¤±è´¥: {str(e)}',
            'data': None
        }), 500
```

### 5.2 æœåŠ¡å±‚å®ç°

```python
@staticmethod
def update_manual_progress(project_id: int, progress: int) -> Dict[str, Any]:
    """
    æ›´æ–°é¡¹ç›®çš„æ‰‹åŠ¨è¿›åº¦
    """
    try:
        project = Project.query.get(project_id)
        if not project:
            return {
                'success': False,
                'message': 'é¡¹ç›®ä¸å­˜åœ¨',
                'data': None
            }
        
        status = project.status.value
        
        # æ£€æŸ¥æ˜¯å¦å…è®¸æ‰‹åŠ¨è®¾ç½®è¿›åº¦
        allowed_statuses = ['initial_contact', 'proposal_submitted', 
                          'quotation_submitted', 'user_confirmation', 
                          'contract_signed']
        
        if status not in allowed_statuses:
            return {
                'success': False,
                'message': f'å½“å‰çŠ¶æ€ "{status}" ä¸å…è®¸æ‰‹åŠ¨è®¾ç½®è¿›åº¦',
                'data': None
            }
        
        # è·å–è¿›åº¦èŒƒå›´é™åˆ¶
        limits = ProjectService.get_progress_limits(status)
        
        # éªŒè¯è¿›åº¦èŒƒå›´
        if progress < limits['min']:
            return {
                'success': False,
                'message': f'è¿›åº¦ä¸èƒ½ä½äº {limits["min"]}%ï¼ˆå‰ä¸€é˜¶æ®µä¸Šé™ï¼‰',
                'data': {'min': limits['min'], 'max': limits['max']}
            }
        
        if progress > limits['max']:
            return {
                'success': False,
                'message': f'è¿›åº¦ä¸èƒ½è¶…è¿‡ {limits["max"]}%ï¼ˆå½“å‰é˜¶æ®µä¸Šé™ï¼‰',
                'data': {'min': limits['min'], 'max': limits['max']}
            }
        
        # æ›´æ–°æ‰‹åŠ¨è¿›åº¦
        project.manual_progress = progress
        project.updated_at = datetime.now()
        
        db.session.commit()
        
        # é‡æ–°è®¡ç®—é¡¹ç›®è¿›åº¦
        progress_info = ProjectService.calculate_project_progress(project)
        
        return {
            'success': True,
            'message': f'è¿›åº¦å·²æ›´æ–°ä¸º {progress}%',
            'data': {
                'manual_progress': progress,
                'calculated_progress': progress_info['progress'],
                'limits': limits,
                'info': progress_info.get('info', '')
            }
        }
        
    except Exception as e:
        db.session.rollback()
        return {
            'success': False,
            'message': f'æ›´æ–°è¿›åº¦å¤±è´¥: {str(e)}',
            'data': None
        }

@staticmethod
def get_progress_limits(status: str) -> Dict[str, int]:
    """è·å–çŠ¶æ€å¯¹åº”çš„è¿›åº¦èŒƒå›´"""
    LIMITS = {
        'initial_contact': {'min': 0, 'max': 5, 'default': 5, 'stage': 1},
        'proposal_submitted': {'min': 5, 'max': 15, 'default': 15, 'stage': 2},
        'quotation_submitted': {'min': 15, 'max': 20, 'default': 20, 'stage': 3},
        'user_confirmation': {'min': 20, 'max': 25, 'default': 25, 'stage': 4},
        'contract_signed': {'min': 25, 'max': 35, 'default': 35, 'stage': 5}
    }
    return LIMITS.get(status, {'min': 0, 'max': 100, 'default': 0, 'stage': 0})
```

---

## å…­ã€å‰ç«¯å®ç°

### 6.1 è¿›åº¦ç¼–è¾‘å¯¹è¯æ¡†

```vue
<template>
  <el-dialog
    v-model="visible"
    title="æ›´æ–°é¡¹ç›®è¿›åº¦"
    width="500px"
  >
    <div class="progress-editor">
      <!-- å½“å‰çŠ¶æ€ -->
      <div class="current-status">
        <span class="label">å½“å‰çŠ¶æ€ï¼š</span>
        <el-tag>{{ getStatusLabel(project.status) }}</el-tag>
      </div>
      
      <!-- è¿›åº¦æ¥æº -->
      <div class="progress-source">
        <span class="label">è¿›åº¦æ¥æºï¼š</span>
        <span v-if="hasModules" class="source-type">
          ğŸ“¦ æ¨¡å—è¿›åº¦ï¼ˆ{{ moduleCount }}ä¸ªæ¨¡å—ï¼‰
        </span>
        <span v-else class="source-type">
          âœ‹ æ‰‹åŠ¨è®¾ç½®
        </span>
      </div>
      
      <!-- å¦‚æœæœ‰æ¨¡å—ï¼Œæ˜¾ç¤ºæç¤º -->
      <el-alert
        v-if="hasModules"
        type="info"
        :closable="false"
        show-icon
      >
        <template #title>
          é¡¹ç›®è¿›åº¦å°†åŸºäºæ¨¡å—è¿›åº¦è‡ªåŠ¨è®¡ç®—
        </template>
        å½“å‰æ¨¡å—å¹³å‡è¿›åº¦ï¼š{{ avgModuleProgress }}%<br>
        æ˜ å°„åˆ°é˜¶æ®µèŒƒå›´ï¼š{{ progressLimits.min }}% - {{ progressLimits.max }}%<br>
        è®¡ç®—åçš„è¿›åº¦ï¼š{{ calculatedProgress }}%
      </el-alert>
      
      <!-- å¦‚æœæ²¡æœ‰æ¨¡å—ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥ -->
      <div v-else class="manual-input">
        <div class="progress-range-info">
          <span class="label">å…è®¸èŒƒå›´ï¼š</span>
          <span class="range">{{ progressLimits.min }}% - {{ progressLimits.max }}%</span>
        </div>
        
        <el-form-item label="é¡¹ç›®è¿›åº¦">
          <el-slider
            v-model="manualProgress"
            :min="progressLimits.min"
            :max="progressLimits.max"
            :marks="marks"
            show-stops
          />
          <div class="progress-value">{{ manualProgress }}%</div>
        </el-form-item>
        
        <el-alert
          type="warning"
          :closable="false"
          show-icon
        >
          ğŸ’¡ æç¤ºï¼šè¿›åº¦èŒƒå›´å—å½“å‰çŠ¶æ€é™åˆ¶ã€‚å¦‚éœ€æ›´å¤§èŒƒå›´ï¼Œè¯·å…ˆæ›´æ–°é¡¹ç›®çŠ¶æ€ã€‚
        </el-alert>
      </div>
    </div>
    
    <template #footer>
      <el-button @click="visible = false">å–æ¶ˆ</el-button>
      <el-button
        v-if="!hasModules"
        type="primary"
        @click="handleSubmit"
        :loading="loading"
      >
        ä¿å­˜
      </el-button>
    </template>
  </el-dialog>
</template>

<script setup>
import { ref, computed, watch } from 'vue'
import { ElMessage } from 'element-plus'
import { projectApi } from '@/utils/api'

const props = defineProps({
  modelValue: Boolean,
  project: Object
})

const emit = defineEmits(['update:modelValue', 'success'])

const visible = computed({
  get: () => props.modelValue,
  set: (val) => emit('update:modelValue', val)
})

const loading = ref(false)
const manualProgress = ref(0)

// è®¡ç®—å±æ€§
const hasModules = computed(() => {
  return props.project?.modules?.length > 0
})

const moduleCount = computed(() => {
  return props.project?.modules?.length || 0
})

const avgModuleProgress = computed(() => {
  if (!hasModules.value) return 0
  const total = props.project.modules.reduce((sum, m) => sum + m.progress, 0)
  return Math.round(total / props.project.modules.length)
})

const progressLimits = computed(() => {
  // æ ¹æ®é¡¹ç›®çŠ¶æ€è·å–è¿›åº¦èŒƒå›´
  const status = props.project?.status
  const limits = getProgressLimitsByStatus(status)
  return limits
})

const calculatedProgress = computed(() => {
  if (!hasModules.value) return manualProgress.value
  
  const limits = progressLimits.value
  const rangeSize = limits.max - limits.min
  return Math.round(limits.min + (avgModuleProgress.value / 100 * rangeSize))
})

const marks = computed(() => {
  const limits = progressLimits.value
  return {
    [limits.min]: `${limits.min}%`,
    [limits.max]: `${limits.max}%`
  }
})

// æ–¹æ³•
function getProgressLimitsByStatus(status) {
  const LIMITS = {
    'initial_contact': { min: 0, max: 5 },
    'proposal_submitted': { min: 5, max: 15 },
    'quotation_submitted': { min: 15, max: 20 },
    'user_confirmation': { min: 20, max: 25 },
    'contract_signed': { min: 25, max: 35 }
  }
  return LIMITS[status] || { min: 0, max: 100 }
}

function getStatusLabel(status) {
  const labels = {
    'initial_contact': 'åˆæ­¥æ¥è§¦',
    'proposal_submitted': 'æäº¤æ–¹æ¡ˆ',
    'quotation_submitted': 'æäº¤æŠ¥ä»·',
    'user_confirmation': 'ç”¨æˆ·ç¡®è®¤',
    'contract_signed': 'åˆåŒç­¾è®¢'
  }
  return labels[status] || status
}

async function handleSubmit() {
  try {
    loading.value = true
    
    const response = await projectApi.updateManualProgress(
      props.project.id,
      manualProgress.value
    )
    
    if (response.success) {
      ElMessage.success(response.message)
      emit('success')
      visible.value = false
    } else {
      ElMessage.error(response.message)
    }
  } catch (error) {
    console.error('æ›´æ–°è¿›åº¦å¤±è´¥:', error)
    ElMessage.error(error.response?.data?.message || 'æ›´æ–°è¿›åº¦å¤±è´¥')
  } finally {
    loading.value = false
  }
}

// ç›‘å¬å¯¹è¯æ¡†æ‰“å¼€
watch(visible, (newVal) => {
  if (newVal && props.project) {
    manualProgress.value = props.project.manual_progress || progressLimits.value.default
  }
})
</script>
```

---

## ä¸ƒã€æ•°æ®é‡ç½®è„šæœ¬

```python
# migrate_reset_all_progress.py
"""
é‡ç½®æ‰€æœ‰é¡¹ç›®è¿›åº¦
- æ¸…ç©ºæ‰€æœ‰æ‰‹åŠ¨è¿›åº¦
- æ ¹æ®æ–°é€»è¾‘é‡æ–°è®¡ç®—æ‰€æœ‰é¡¹ç›®è¿›åº¦
"""

from backend.models.database import db, Project
from backend.services.project_service import ProjectService

def reset_all_project_progress():
    """é‡ç½®æ‰€æœ‰é¡¹ç›®è¿›åº¦"""
    try:
        projects = Project.query.all()
        
        print(f"å¼€å§‹é‡ç½® {len(projects)} ä¸ªé¡¹ç›®çš„è¿›åº¦...")
        print("-" * 50)
        
        for project in projects:
            # æ¸…ç©ºæ‰‹åŠ¨è¿›åº¦
            old_manual = project.manual_progress
            old_progress = project.progress
            project.manual_progress = None
            
            # é‡æ–°è®¡ç®—è¿›åº¦
            progress_info = ProjectService.calculate_project_progress(project)
            new_progress = progress_info['progress']
            project.progress = new_progress
            
            print(f"é¡¹ç›®: {project.name}")
            print(f"  çŠ¶æ€: {project.status.value}")
            print(f"  æ—§è¿›åº¦: {old_progress}% (æ‰‹åŠ¨: {old_manual})")
            print(f"  æ–°è¿›åº¦: {new_progress}% (æ¥æº: {progress_info.get('source')})")
            print(f"  æ¨¡å—æ•°: {len(project.modules)}")
            print("-" * 50)
        
        db.session.commit()
        
        print(f"\nâœ… æˆåŠŸé‡ç½® {len(projects)} ä¸ªé¡¹ç›®çš„è¿›åº¦ï¼")
        
    except Exception as e:
        db.session.rollback()
        print(f"âŒ é‡ç½®å¤±è´¥: {str(e)}")
        raise

if __name__ == '__main__':
    from backend.app import app
    with app.app_context():
        reset_all_project_progress()
```

---

## å…«ã€å®æ–½æ­¥éª¤

### Step 1: æ•°æ®åº“è¿ç§»
```bash
cd backend
python migrate_add_manual_progress.py
```

### Step 2: é‡ç½®æ‰€æœ‰é¡¹ç›®è¿›åº¦
```bash
python migrate_reset_all_progress.py
```

### Step 3: éƒ¨ç½²åç«¯ä»£ç 
- æ›´æ–° `ProjectService.calculate_project_progress()`
- æ–°å¢ `ProjectService.update_manual_progress()`
- æ–°å¢ API è·¯ç”±

### Step 4: éƒ¨ç½²å‰ç«¯ä»£ç 
- åˆ›å»ºè¿›åº¦ç¼–è¾‘å¯¹è¯æ¡†ç»„ä»¶
- æ›´æ–°é¡¹ç›®è¯¦æƒ…é¡µ

### Step 5: æµ‹è¯•éªŒè¯
- æµ‹è¯•å‰æœŸé˜¶æ®µæ‰‹åŠ¨è¿›åº¦æ›´æ–°
- æµ‹è¯•å‰æœŸé˜¶æ®µæ¨¡å—è¿›åº¦æ˜ å°„
- æµ‹è¯•é¡¹ç›®å®æ–½é˜¶æ®µè¿›åº¦è®¡ç®—
- æµ‹è¯•è¿›åº¦èŒƒå›´é™åˆ¶

---

## ä¹ã€æµ‹è¯•ç”¨ä¾‹

### ç”¨ä¾‹1ï¼šå‰æœŸé˜¶æ®µï¼Œæ— æ¨¡å—ï¼Œæ‰‹åŠ¨è®¾ç½®
```
åœºæ™¯ï¼šæäº¤æ–¹æ¡ˆé˜¶æ®µï¼Œæ²¡æœ‰æ¨¡å—
æ“ä½œï¼šæ‰‹åŠ¨è®¾ç½®è¿›åº¦ä¸º 10%
é¢„æœŸï¼šæˆåŠŸï¼Œè¿›åº¦æ˜¾ç¤º 10%
```

### ç”¨ä¾‹2ï¼šå‰æœŸé˜¶æ®µï¼Œæ— æ¨¡å—ï¼Œè¶…å‡ºèŒƒå›´
```
åœºæ™¯ï¼šæäº¤æ–¹æ¡ˆé˜¶æ®µï¼ˆèŒƒå›´5-15%ï¼‰
æ“ä½œï¼šå°è¯•è®¾ç½®è¿›åº¦ä¸º 20%
é¢„æœŸï¼šå¤±è´¥ï¼Œæç¤º"è¿›åº¦ä¸èƒ½è¶…è¿‡15%"
```

### ç”¨ä¾‹3ï¼šå‰æœŸé˜¶æ®µï¼Œæœ‰æ¨¡å—ï¼Œè‡ªåŠ¨æ˜ å°„
```
åœºæ™¯ï¼šæäº¤æ–¹æ¡ˆé˜¶æ®µï¼Œæœ‰3ä¸ªæ¨¡å—ï¼ˆ80%, 60%, 40%ï¼‰
æ“ä½œï¼šæ— éœ€æ‰‹åŠ¨è®¾ç½®
é¢„æœŸï¼šè¿›åº¦è‡ªåŠ¨è®¡ç®—ä¸º 11%ï¼ˆæ˜ å°„åˆ°5-15%èŒƒå›´ï¼‰
```

### ç”¨ä¾‹4ï¼šé¡¹ç›®å®æ–½é˜¶æ®µï¼Œæœ‰æ¨¡å—
```
åœºæ™¯ï¼šé¡¹ç›®å®æ–½é˜¶æ®µï¼Œæœ‰3ä¸ªæ¨¡å—ï¼ˆ100%, 60%, 30%ï¼‰
æ“ä½œï¼šæ— éœ€æ‰‹åŠ¨è®¾ç½®
é¢„æœŸï¼šè¿›åº¦è‡ªåŠ¨è®¡ç®—ä¸º 76%ï¼ˆ35% + 63.3% Ã— 65%ï¼‰
```

---

*æ–¹æ¡ˆè®¾è®¡å®Œæˆäº 2025å¹´11æœˆ4æ—¥*

